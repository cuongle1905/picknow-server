@page
@model GetNowServer.Pages.StoresModel

<script>
    selectedMenuItemId = "#ni-stores"
    var provincesUrl = '@Url.Action("ProvincesLookup", "Districts")'
    var provinces;
    $.ajax({
        url: provincesUrl,
        type: "GET",
        success: function (data) {
            provinces = data["data"];
            console.log("Received provinces: ");
            $("#my-div").append(provinces[0]["Name"]);
        }
    });
    var districtsUrl = '@Url.Action("Get", "Districts")'
    var districts;
    $.ajax({
        url: districtsUrl,
        type: "GET",
        success: function (data) {
            districts = data["data"];
            console.log("Received districts: ");
            $("#my-div").append(districts[0]["Name"]);
        }
    });
    var wardsUrl = '@Url.Action("Get", "Wards")'
    var wards;
    $.ajax({
        url: wardsUrl,
        type: "GET",
        success: function (data) {
            wards = data["data"];
            console.log("Received wards: ");
            $("#my-div").append(wards[0]["Name"]);
        }
    });
    var companiesUrl = '@Url.Action("Get", "Companies")'
    var companies;
    $.ajax({
        url: companiesUrl,
        type: "GET",
        success: function (data) {
            companies = data["data"];
            console.log("Received companies: ");
            $("#my-div").append(companies[0]["Name"]);
        }
    });

</script>
<h2 class="content-block">Stores</h2>
@(Html.DevExtreme().DataGrid<GetNowServer.Models.Store>()
    .DataSource(ds => ds.Mvc()
        .Controller("Stores")
        .LoadAction("Get")
        .InsertAction("Post")
        .UpdateAction("Put")
        .DeleteAction("Delete")
        .Key("Id")
    )
    .ShowBorders(true)
    .OnEditorPreparing("onEditorPreparing")
    //.RemoteOperations(true)
    .Columns(columns => {

        columns.AddFor(m => m.Id).Alignment(HorizontalAlignment.Center).CssClass("col-1");

        columns.AddFor(m => m.Name).CalculateFilterExpression(@<text>
            function (filterValue, selectedFilterOperation, target) {
                return filterTextVN(filterValue, selectedFilterOperation);
            }
        </text>);

        columns.AddFor(m => m.Province)
            .CssClass("col-1")
            .SetCellValue("setProvince")
            .Lookup(lookup => lookup
                //.DataSource(ds => ds.WebApi().Controller("Stores").LoadAction("ProvincesLookup").Key("Value"))
                .DataSource("getProvinces")
                .ValueExpr("Value")
                .DisplayExpr("Text")
            );

        columns.AddFor(m => m.District)
            .SetCellValue("setDistrict")
            .Lookup(lookup => lookup
                .DataSource("getDistricts")
                .ValueExpr("Id")
                .DisplayExpr("Name")
            );

        columns.AddFor(m => m.Ward).Lookup(lookup => lookup
            .DataSource("getWards")
            .ValueExpr("Id")
            .DisplayExpr("Name")
        );

        columns.AddFor(m => m.Address);

        columns.AddFor(m => m.Company).Lookup(lookup => lookup
            .DataSource("getCompanies")
            .ValueExpr("Id")
            .DisplayExpr("Name")
        );

        /*columns.AddFor(m => m.ContactName);

        columns.AddFor(m => m.ContactPhone);

        columns.AddFor(m => m.ContactPhone2);

        columns.AddFor(m => m.Website);*/
    })
    .FilterRow(filterRow => filterRow
        .Visible(true)
        .ApplyFilter(GridApplyFilterMode.Auto)
    )
    .Editing(e => e
        .Mode(GridEditMode.Popup)
        .AllowAdding(true)
        .AllowUpdating(true)
        .AllowDeleting(true)
        .Popup(p => p
            .Title("Store Info")
            .ShowTitle(true)
            .Width(700)
            .Height(525)
        )
        .Form(f => f.Items(items => {
            items.AddGroup()
                .ColCount(2)
                .ColSpan(2)
                .Items(groupItems =>
                {
                    groupItems.AddSimpleFor(m => m.Id);
                    groupItems.AddSimpleFor(m => m.Name);
                    groupItems.AddSimpleFor(m => m.Company);
                //groupItems.AddSimpleFor(m => m.Notes).ColSpan(2).Editor(editor => editor.TextArea().Height(100));
            });
            items.AddGroup()
                .Caption("Address")
                .ColCount(2)
                .ColSpan(2)
                .Items(groupItems =>
                {
                    groupItems.AddSimpleFor(m => m.Province);
                    groupItems.AddSimpleFor(m => m.District);
                    groupItems.AddSimpleFor(m => m.Ward);
                    groupItems.AddSimpleFor(m => m.Address);
                });

            //items.AddGroup()
            //    .Caption("Home Address")
            //    .ColCount(2)
            //    .ColSpan(2)
            //    .Items(groupItems =>
            //    {
            //        groupItems.AddSimpleFor(m => m.StateID);
            //        groupItems.AddSimpleFor(m => m.Address);
            //    });
        }))
    )
    .OnInitNewRow(@<text>
        function(e) {
            e.data.Province = 1;
            e.component.option("editing.popup.title", "Create New Store");
        }
    </text>)
    .OnEditingStart(@<text>
        function(e) {
            e.component.option("editing.popup.title", "Update Store: " + e.data.Name);
        }
    </text>)
)
<script>

    function onEditorPreparing(e) {
        if (e.parentType === "dataRow") {
            if (e.dataField === "District")
                e.editorOptions.disabled = (typeof e.row.data.Province !== "number");
            else if (e.dataField === "Ward")
                e.editorOptions.disabled = (typeof e.row.data.District !== "number");
        }
    }
    function getProvinces(options) {
        if (provinces == undefined) {
            console.log("Load provinces from server.");
            return {
                store: DevExpress.data.AspNet.createStore({
                    key: "Id",
                    loadMode: "raw",
                    cacheRawData: true,
                    loadUrl: provincesUrl
                })
            };
        } else {
            console.log("Load provinces from client.");
            return provinces;
        }
    }
    function getDistricts(options) {
        if (districts == undefined) {
            console.log("Load districts from server.");
            return {
                store: DevExpress.data.AspNet.createStore({
                    key: "Id",
                    loadMode: "raw",
                    cacheRawData: true,
                    loadUrl: districtsUrl
                }),
                filter: options.data ? ["Province", "=", options.data.Province] : null
            };
        } else {
            console.log("Load districts from client.");
            return options.data ? districts.filter(d => d.Province == options.data.Province) : districts;
        }
    }
    function setProvince(rowData, value) {
        rowData.Province = value;
        rowData.District = null;
    }
    function getWards(options) {
        if (wards == undefined) {
            console.log("Load wards from server.");
            return {
                store: DevExpress.data.AspNet.createStore({
                    key: "Id",
                    loadMode: "raw",
                    cacheRawData: true,
                    loadUrl: wardsUrl //'@Url.Action("Get", "WardsLookup", new { httproute = true })'
                })/*,
                filter: options.data ? ["District", "=", options.data.District] : null*/
            };
        } else {
            console.log("Load wards from client.");
            return options.data ? wards.filter(w => w.District == options.data.District) : wards;
        }
    }
    function setDistrict(rowData, value) {
        rowData.District = value;
        rowData.Ward = null;
    }
    function getCompanies(options) {
        if (companies == undefined) {
            console.log("Load companies from server.");
            return {
                store: DevExpress.data.AspNet.createStore({
                    key: "Id",
                    loadMode: "raw",
                    cacheRawData: true,
                    loadUrl: companiesUrl
                })
            };
        } else {
            console.log("Load companies from client.");
            return companies
        }
    }
</script>